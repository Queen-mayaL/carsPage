<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Management</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <h1>Car Management</h1>

    <!-- Add a new car -->
    <h2>Add a New Car</h2>
    <form id="add-car-form" onsubmit="event.preventDefault(); addCar();">
        <label for="make">Make:</label>
        <input type="text" id="make" required>
        <br>
        <label for="model">Model:</label>
        <input type="text" id="model" required>
        <br>
        <label for="year">Year:</label>
        <input type="number" id="year" required>
        <br>
        <label for="image">Car Image:</label>
        <input type="file" id="image" accept="image/*">
        <br><br>
        <button type="submit">Add Car</button>
    </form>

    <!-- List of all cars -->
    <h2>All Cars</h2>
    <ul id="car-list"></ul>

    <script>
        const baseURL = "https://crudcloudagain-2.onrender.com";

        async function getCars() {
            try {
                const response = await axios.get(`${baseURL}/cars`);
                const cars = response.data;
                const carList = document.getElementById("car-list");
                carList.innerHTML = "";

                cars.forEach(car => {
                    const carItem = document.createElement("li");
                    carItem.innerHTML = `
                        ${car.make} ${car.model} (${car.year})
                        ${car.image_url ? `<br><img src="${baseURL}${car.image_url}" alt="Car Image" width="100">` : ''}
                        <br>
                        <input type="file" onchange="uploadCarImage(${car.id}, this.files[0])">
                        <button onclick="deleteCar(${car.id})">Delete</button>
                        <button onclick="updateCar(${car.id})">Update</button>
                    `;
                    carList.appendChild(carItem);
                });
            } catch (error) {
                console.error("Error fetching cars:", error);
            }
        }

        async function addCar() {
            const make = document.getElementById("make").value;
            const model = document.getElementById("model").value;
            const year = parseInt(document.getElementById("year").value);
            const imageFile = document.getElementById("image").files[0];

            try {
                const response = await axios.post(`${baseURL}/cars`, [{ make, model, year }], {
                    headers: { "Content-Type": "application/json" },
                });
                if (imageFile) {
                    await uploadCarImage(response.data[0].id, imageFile);
                }
                getCars();
                document.getElementById("add-car-form").reset();
            } catch (error) {
                console.error("Error adding car:", error);
            }
        }

        async function uploadCarImage(carId, file) {
            const formData = new FormData();
            formData.append("file", file);
            try {
                await axios.post(`${baseURL}/cars/${carId}/upload_image`, formData, {
                    headers: { "Content-Type": "multipart/form-data" },
                });
                getCars();
            } catch (error) {
                console.error("Error uploading image:", error);
            }
        }

        // Delete a car
        async function deleteCar(carId) {
            try {
                await axios.delete(`${baseURL}/cars/${carId}`);
                getCars(); // Refresh the list
            } catch (error) {
                console.error("Error deleting car:", error);
            }
        }

        // Update a car
        async function updateCar(carId) {
            const make = prompt("Enter new make:");
            const model = prompt("Enter new model:");
            const year = prompt("Enter new year:");

            if (!make || !model || !year) {
                alert("All fields are required!");
                return;
            }

            try {
                await axios.put(`${baseURL}/cars/${carId}`, { make, model, year: parseInt(year) }, {
                    headers: { "Content-Type": "application/json" },
                });
                getCars(); // Refresh the list
            } catch (error) {
                console.error("Error updating car:", error);
            }
        }

        // Initialize by fetching all cars
        window.onload = getCars;
    </script>
</body>

</html>